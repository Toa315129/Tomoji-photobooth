<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tomoji Photobooth</title>
<style>
body{
  background:#fdfaf4;
  font-family:"Comic Sans MS", "Segoe UI", cursive;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:20px;
}
.container{max-width:420px;text-align:center;}
.preview{position:relative;width:360px;height:540px;margin:0 auto;border:6px solid #a7d8f7;border-radius:16px;overflow:hidden;background:#fff;}
#video{width:100%;height:100%;object-fit:cover;}
#overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
.controls{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:center;}
button{
  padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:bold;
  background:#ffd6e8;color:#333;transition:0.2s;
}
button:hover{background:#90c9a7;color:#fff;}
#countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  font-size:4rem;color:#ff3366;font-weight:bold;text-shadow:2px 2px #fff;}
#gallery{margin-top:14px;}
</style>
</head>
<body>
<h1>üíñ Tomoji Photobooth üíñ</h1>
<div class="container">
  <div class="preview">
    <video id="video" autoplay playsinline></video>
    <div id="countdown"></div>
    <!-- ‡∏Å‡∏£‡∏≠‡∏ö PNG ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ -->
    <img id="overlay" src="IMG_2877.png" alt="‡∏Å‡∏£‡∏≠‡∏ö‡πÇ‡∏ü‡πÇ‡∏ï‡πâ‡∏ö‡∏π‡∏ò">
  </div>
  <div class="controls">
    <button id="shutter">üì∏ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ñ‡πà‡∏≤‡∏¢</button>
    <button id="download" disabled>‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</button>
    <button id="print" disabled>üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô</button>
    <button id="makeqr" disabled>üîó ‡∏™‡∏£‡πâ‡∏≤‡∏á QR</button>
  </div>
  <div id="gallery"></div>
  <div id="qrcode"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
(async()=>{
const video=document.getElementById("video");
const shutter=document.getElementById("shutter");
const downloadBtn=document.getElementById("download");
const printBtn=document.getElementById("print");
const qrBtn=document.getElementById("makeqr");
const countdownEl=document.getElementById("countdown");
const gallery=document.getElementById("gallery");
let stream=null,captures=[],finalImage=null;

async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    video.srcObject=stream;
  }catch(e){alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: "+e);}
}
startCamera();

function captureFrame(){
  const c=document.createElement("canvas");
  c.width=video.videoWidth; c.height=video.videoHeight;
  const ctx=c.getContext("2d");
  ctx.drawImage(video,0,0,c.width,c.height);
  return c.toDataURL("image/png");
}

function showCount(n){countdownEl.textContent=n;}
function hideCount(){countdownEl.textContent="";}

async function takeSequence(){
  captures=[];
  for(let i=0;i<2;i++){
    for(let s=3;s>=1;s--){showCount(s);await new Promise(r=>setTimeout(r,1000));}
    hideCount();
    captures.push(captureFrame());
    if(i<1) await new Promise(r=>setTimeout(r,1000)); // ‡πÄ‡∏ß‡πâ‡∏ô 1 ‡∏ß‡∏¥
  }
  await buildFinal();
  downloadBtn.disabled=false;
  printBtn.disabled=false;
  qrBtn.disabled=false;
}

async function buildFinal(){
  const overlay=document.getElementById("overlay");
  const frame=await loadImage(overlay.src);

  const W=frame.width,H=frame.height;
  const c=document.createElement("canvas");
  c.width=W; c.height=H;
  const ctx=c.getContext("2d");

  // ‡∏ä‡πà‡∏≠‡∏á‡∏ö‡∏ô
  const img1=await loadImage(captures[0]);
  ctx.drawImage(img1,80,80, W-160, (H/2)-120);

  // ‡∏ä‡πà‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏á
  const img2=await loadImage(captures[1]);
  ctx.drawImage(img2,80,(H/2)+40, W-160, (H/2)-120);

  // ‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡∏ö
  ctx.drawImage(frame,0,0,W,H);

  finalImage=c.toDataURL("image/png");
  gallery.innerHTML=`<img src="${finalImage}" style="width:100%;border:6px solid #90c9a7;border-radius:16px">`;
}

function loadImage(src){
  return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=src;});
}

shutter.addEventListener("click",takeSequence);

downloadBtn.addEventListener("click",()=>{
  const a=document.createElement("a");a.href=finalImage;a.download="photobooth.png";a.click();
});

printBtn.addEventListener("click",()=>{
  const w=window.open("");
  w.document.write(`<img src="${finalImage}" style="width:100%">`);
  w.print();
  w.close();
});

qrBtn.addEventListener("click",()=>{
  document.getElementById("qrcode").innerHTML="";
  new QRCode(document.getElementById("qrcode"),{text:finalImage,width:180,height:180});
});
})();
</script>
</body>
</html>

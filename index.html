<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tomoji PhotoBooth ‚Äî Best Cute Photo Booth</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Patrick+Hand&family=Sriracha&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f2ee;      /* cream */
  --accent:#3b5a99;  /* deep blue */
  --pale:#dfe9ff;
  --pink:#ffb6d0;
  --mint:#b7ead6;
  --yellow:#fff1a8;
  --text:#243042;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);font-family:"Patrick Hand","Sriracha",sans-serif;color:var(--text)}
.container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
.app{width:100%;max-width:1200px;background:#fff;border-radius:18px;padding:20px;border:6px solid var(--accent);box-shadow:0 18px 40px rgba(0,0,0,.08);}

/* header */
.header{display:flex;align-items:center;gap:18px;justify-content:center;margin-bottom:12px}
.logo{width:88px;height:88px;border-radius:50%;background:linear-gradient(180deg,#fff,#f3f3f3);display:flex;align-items:center;justify-content:center;border:3px solid rgba(0,0,0,0.06)}
.title{font-family:"Pacifico",cursive;font-size:34px;color:var(--accent);text-transform:none}
.subtitle{font-size:12px;color:rgba(0,0,0,0.5);text-align:center;margin-top:4px}

/* layout */
.row{display:flex;gap:18px;flex-wrap:wrap}
.left{flex:1 1 680px;min-width:360px}
.right{width:340px;flex:0 0 340px}

/* preview */
.preview{background:#fff;border-radius:14px;border:6px solid var(--pale);overflow:hidden;aspect-ratio:3/4;position:relative;display:flex;align-items:center;justify-content:center}
video{width:100%;height:100%;object-fit:cover;display:block}
.preview-overlay{position:absolute;inset:0;pointer-events:none}
.countdown{position:absolute;left:50%;top:48%;transform:translate(-50%,-50%);font-size:72px;color:var(--pink);font-weight:800;text-shadow:0 6px 20px rgba(0,0,0,0.12)}
.flash{position:absolute;inset:0;background:#fff;opacity:0;transition:opacity .18s}

/* controls */
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;margin-top:12px}
.btn{padding:10px 14px;border-radius:12px;border:2px solid var(--accent);background:var(--pale);cursor:pointer;font-weight:700}
.btn.primary{background:var(--accent);color:#fff}
.btn:disabled{opacity:.5;cursor:not-allowed}
.shutter{width:76px;height:76px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#fff;border:6px solid var(--accent);font-size:30px;cursor:pointer}

/* right panel */
.panel{background:#fff;border-radius:12px;padding:12px;border:3px solid #eee;margin-bottom:12px}
.panel h4{margin:0 0 8px;font-size:14px;color:var(--accent);text-transform:uppercase}

/* QR area */
#qrcode{display:flex;align-items:center;justify-content:center;padding:8px;background:#fff;border-radius:8px;border:2px dashed #e6e6e6;min-height:120px}

/* result preview 4x6 box */
.resultWrap{display:flex;align-items:center;justify-content:center;margin-top:14px}
.result{width:360px;height:540px;background:#fff;border-radius:14px;border:6px solid var(--pink);padding:10px;position:relative;box-shadow:0 8px 28px rgba(0,0,0,0.06)}
.result .brand{position:absolute;left:50%;top:-28px;transform:translateX(-50%);background:var(--pale);color:var(--accent);padding:6px 12px;border-radius:18px;border:3px solid var(--accent);font-family:"Pacifico";}

/* three slots vertical */
.slot{height:33%;margin-bottom:8px;border-radius:12px;overflow:hidden;position:relative;display:flex;align-items:center;justify-content:center;font-size:20px}
.slot img{width:100%;height:100%;object-fit:cover}

/* themed frames */
.slot.heart{background:linear-gradient(180deg,#fff0f6, #fff6fb);border:6px dashed var(--pink);box-shadow:inset 0 4px 0 rgba(255,255,255,0.5)}
.slot.square{background:linear-gradient(180deg,#f0f9ff,#f7fdff);border:6px solid var(--pale)}
.slot.star{background:linear-gradient(180deg,#f3fff6,#fbfff9);border:6px dotted var(--mint)}

/* decorative labels */
.label{position:absolute;font-family:"Patrick Hand";font-weight:700;padding:6px 10px;border-radius:12px;background:#fff;box-shadow:0 6px 16px rgba(0,0,0,0.08);}

/* footer */
.credits{margin-top:12px;text-align:center;color:rgba(0,0,0,0.6);font-size:13px}
.controls-row{display:flex;gap:8px;align-items:center;justify-content:center}
select, input[type=file]{padding:8px;border-radius:10px;border:1px solid #ddd}
.small{font-size:13px;color:rgba(0,0,0,0.6)}
</style>
</head>
<body>
<div class="container">
  <div class="app" role="application" aria-label="Tomoji Photo Booth">
    <div class="header">
      <div class="logo" aria-hidden="true">
        <!-- small emblem -->
        <svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
          <g fill="none" stroke="#3b5a99" stroke-width="1.6"><ellipse cx="24" cy="12" rx="14" ry="6"/><path d="M7 12c8 8 30 8 36 0"/><path d="M24 10v28"/></g>
        </svg>
      </div>
      <div>
        <div class="title">Tomoji PhotoBooth</div>
        <div class="subtitle small">‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏™‡∏ß‡∏¢ ‡πÉ‡∏™ ‚Äî Export 4√ó6 inch</div>
      </div>
    </div>

    <div class="row">
      <!-- LEFT: camera / controls -->
      <div class="left">
        <div class="preview" id="preview">
          <video id="video" playsinline autoplay></video>
          <div class="preview-overlay">
            <div class="countdown" id="countdown"></div>
            <div class="flash" id="flash"></div>
          </div>
        </div>

        <div class="controls">
          <div class="shutter" id="shutter" title="‡∏ñ‡πà‡∏≤‡∏¢ (3 ‡∏ä‡πá‡∏≠‡∏ï)">üì∏</div>
          <div class="controls-row">
            <button class="btn" id="uploadBtn">üìÅ Upload 3</button>
            <button class="btn" id="retakeBtn" disabled>üîÅ Retake</button>
            <button class="btn primary" id="downloadBtn" disabled>‚¨áÔ∏è Download</button>
            <button class="btn" id="printBtn" disabled>üñ®Ô∏è Print</button>
            <button class="btn" id="qrBtn" disabled>üîó QR</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;align-items:center;">
          <label class="small">Timer</label>
          <select id="timer">
            <option value="2">2s</option>
            <option value="3" selected>3s</option>
            <option value="5">5s</option>
          </select>
          <label class="small" style="margin-left:8px">Filter</label>
          <select id="filter">
            <option value="none">Normal</option>
            <option value="bw">B&W</option>
            <option value="sepia">Warm</option>
            <option value="vivid">Vivid</option>
          </select>
        </div>
      </div>

      <!-- RIGHT: preview result + QR -->
      <div class="right">
        <div class="panel">
          <h4>Result (4√ó6 preview)</h4>
          <div class="resultWrap">
            <div class="result" id="resultCanvasWrap">
              <div class="brand">TOMOJI PHOTOBOOTH</div>

              <div class="slot heart" id="slot1"><span class="label" style="left:10px;top:8px">CUTE</span></div>
              <div class="slot square" id="slot2"><span class="label" style="right:10px;top:8px">MEMORIES</span></div>
              <div class="slot star" id="slot3"><span class="label" style="left:10px;bottom:8px">FUN</span></div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h4>QR / Download</h4>
          <div id="qrcode">No QR yet</div>
          <div style="margin-top:8px;display:flex;gap:8px;justify-content:center">
            <button class="btn" id="downloadFinal" disabled>Download Image</button>
            <button class="btn" id="openLink" disabled>Open Link</button>
          </div>
        </div>

        <div class="panel">
          <h4>Tips</h4>
          <div class="small">‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô HTTPS / localhost<br>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ñ‡∏≤‡∏°</div>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:12px" class="credits">@tomoji studio ‚Ä¢ made with ‚ô•</div>
  </div>
</div>

<!-- QR lib -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
/* Tomoji PhotoBooth ‚Äî Full single-file app
 - 3-shot sequence (top-heart, mid-rectangle, bottom-star)
 - upload 3 images
 - filters preview (applied on capture)
 - build final 4x6 image (1200x1800 px)
 - download / print / QR (blob URL)
*/

const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const uploadBtn = document.getElementById('uploadBtn');
const retakeBtn = document.getElementById('retakeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const printBtn = document.getElementById('printBtn');
const qrBtn = document.getElementById('qrBtn');
const timerSel = document.getElementById('timer');
const filterSel = document.getElementById('filter');
const slotEls = [document.getElementById('slot1'), document.getElementById('slot2'), document.getElementById('slot3')];
const countdownEl = document.getElementById('countdown');
const flashEl = document.getElementById('flash');
const qrcodeContainer = document.getElementById('qrcode');
const downloadFinalBtn = document.getElementById('downloadFinal');
const openLinkBtn = document.getElementById('openLink');

let stream = null;
let captures = [null, null, null]; // data URLs
let finalBlobUrl = null;

/* start camera */
async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
    video.srcObject = stream;
    await video.play();
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + (e.message||e)); }
}
startCamera();

/* helpers */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function playSnap(){ try{ new Audio('https://cdn.jsdelivr.net/gh/naptha/talkdemo/snap.mp3').play(); }catch(e){} }
function flashOnce(){ flashEl.style.opacity=0.85; setTimeout(()=>flashEl.style.opacity=0,160); }

/* apply CSS filter preview */
filterSel.addEventListener('change', ()=>{
  const v = filterSel.value;
  video.style.filter = v === 'bw' ? 'grayscale(1)' : v==='sepia' ? 'sepia(.45) saturate(1.05)' : v==='vivid' ? 'contrast(1.08) saturate(1.2)' : 'none';
});

/* capture frame (applies canvas filter) */
function captureFrameFromVideo(){
  const vw = video.videoWidth, vh = video.videoHeight;
  const c = document.createElement('canvas'); c.width = vw; c.height = vh;
  const ctx = c.getContext('2d');
  // apply same filter on canvas for final consistency
  const v = filterSel.value;
  ctx.filter = v === 'bw' ? 'grayscale(1)' : v==='sepia' ? 'sepia(.45) saturate(1.05)' : v==='vivid' ? 'contrast(1.08) saturate(1.2)' : 'none';
  ctx.drawImage(video,0,0,vw,vh);
  return c.toDataURL('image/png');
}

/* draw heart/rounded star shapes for clipping */
function drawStarPath(ctx, cx, cy, spikes, outerR, innerR){
  let rot = Math.PI/2 * 3;
  let x = cx;
  let y = cy;
  let step = Math.PI / spikes;
  ctx.beginPath();
  ctx.moveTo(cx, cy - outerR);
  for(let i=0;i<spikes;i++){
    x = cx + Math.cos(rot) * outerR;
    y = cy + Math.sin(rot) * outerR;
    ctx.lineTo(x,y);
    rot += step;
    x = cx + Math.cos(rot) * innerR;
    y = cy + Math.sin(rot) * innerR;
    ctx.lineTo(x,y);
    rot += step;
  }
  ctx.closePath();
}

/* draw heart path - centered in given rect */
function clipHeart(ctx, x, y, w, h){
  // using bezier heart shape normalized
  ctx.beginPath();
  const cx = x + w/2;
  const cy = y + h/2.4;
  const top = y + h*0.18;
  ctx.moveTo(cx, y + h*0.9);
  ctx.bezierCurveTo(cx + w*0.6, y + h*0.55, cx + w*0.15, top, cx, top + h*0.02);
  ctx.bezierCurveTo(cx - w*0.15, top, cx - w*0.6, y + h*0.55, cx, y + h*0.9);
  ctx.closePath();
}

/* show thumbnails in UI previews */
function renderSlots(){
  for(let i=0;i<3;i++){
    if(captures[i]) slotEls[i].innerHTML = `<img src="${captures[i]}">`;
    else slotEls[i].innerHTML = '';
  }
}

/* sequence capture: capture from video 3 times (top/mid/bottom) */
shutter.addEventListener('click', async ()=>{
  captures = [null,null,null];
  renderSlots();
  retakeBtn.disabled = true;
  downloadBtn.disabled = true;
  printBtn.disabled = true;
  qrBtn.disabled = true;
  downloadFinalBtn.disabled = true;
  openLinkBtn.disabled = true;
  qrcodeContainer.innerHTML = 'No QR yet';

  const delay = parseInt(timerSel.value || '3', 10);
  for(let i=0;i<3;i++){
    for(let s=delay;s>=1;s--){
      countdownEl.textContent = s;
      await sleep(1000);
    }
    countdownEl.textContent = '';
    playSnap(); flashOnce();
    const data = captureFrameFromVideo();
    captures[i] = data;
    renderSlots();
    await sleep(500);
  }

  retakeBtn.disabled = false;
  downloadBtn.disabled = false;
  printBtn.disabled = false;
  qrBtn.disabled = false;
  downloadFinalBtn.disabled = false;
});

/* retake */
retakeBtn.addEventListener('click', ()=>{
  captures = [null,null,null];
  renderSlots();
  retakeBtn.disabled = true;
  downloadBtn.disabled = true;
  printBtn.disabled = true;
  qrBtn.disabled = true;
  downloadFinalBtn.disabled = true;
  openLinkBtn.disabled = true;
  qrcodeContainer.innerHTML = 'No QR yet';
});

/* upload 3 images */
uploadBtn.addEventListener('click', ()=> {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.multiple = true;
  input.onchange = async (e) => {
    const files = [...e.target.files].slice(0,3);
    if(files.length < 3){ alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏£‡∏π‡∏õ (‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)'); return; }
    for(let i=0;i<3;i++){
      captures[i] = await fileToDataURL(files[i]);
    }
    renderSlots();
    retakeBtn.disabled = false;
    downloadBtn.disabled = false;
    printBtn.disabled = false;
    qrBtn.disabled = false;
    downloadFinalBtn.disabled = false;
  };
  input.click();
});

function fileToDataURL(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* build final 4x6 image (1200x1800) */
async function buildFinalCanvas(){
  if(!captures[0]) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ');
  const W = 1200, H = 1800;
  const canvas = document.createElement('canvas');
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');

  // background cream
  ctx.fillStyle = '#fffdf8';
  ctx.fillRect(0,0,W,H);

  // decorative large background panel (blue-ish)
  ctx.fillStyle = '#dfe9ff';
  roundRect(ctx, 60, 60, W - 120, H - 120, 22);
  ctx.fill();

  // header banner (blue pill)
  ctx.fillStyle = '#a7d8f7';
  roundRect(ctx, 160, 80, W - 320, 140, 28);
  ctx.fill();

  // brand text
  ctx.fillStyle = '#18385f';
  ctx.font = '64px "Pacifico", serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('TOMOJI PHOTOBOOTH', W/2, 150);

  // 3 slot rect area
  const slotX = 140;
  const slotW = W - slotX*2;
  const gap = 28;
  const slotH = Math.floor((H - 320 - gap*2) / 3); // compute so overall fits nicely
  const startY = 240;

  // top: heart clip
  if(captures[0]){
    const img0 = await loadImg(captures[0]);
    // create heart shaped clip
    ctx.save();
    clipHeart(ctx, slotX, startY, slotW, slotH);
    ctx.clip();
    // draw image covering area (contain)
    const scale0 = Math.max(slotW / img0.width, slotH / img0.height);
    const iw0 = img0.width * scale0, ih0 = img0.height * scale0;
    ctx.drawImage(img0, slotX - (iw0 - slotW)/2, startY - (ih0 - slotH)/2, iw0, ih0);
    ctx.restore();

    // stroke heart border
    ctx.lineWidth = 10;
    ctx.strokeStyle = '#ffb6d0';
    ctx.beginPath();
    clipHeart(ctx, slotX, startY, slotW, slotH);
    ctx.stroke();
  }

  // middle: rectangle with rounded corners and label
  const midY = startY + slotH + gap;
  if(captures[1]){
    const img1 = await loadImg(captures[1]);
    // rounded clip
    ctx.save();
    ctx.beginPath();
    roundRect(ctx, slotX, midY, slotW, slotH, 28);
    ctx.clip();
    // draw image - cover / contain aesthetic
    const scale1 = Math.max(slotW / img1.width, slotH / img1.height);
    const iw1 = img1.width * scale1, ih1 = img1.height * scale1;
    ctx.drawImage(img1, slotX - (iw1 - slotW)/2, midY - (ih1 - slotH)/2, iw1, ih1);
    ctx.restore();

    // rectangle border
    ctx.lineWidth = 10;
    ctx.strokeStyle = '#9fcfff';
    roundRect(ctx, slotX, midY, slotW, slotH, 28);
    ctx.stroke();

    // decorative sticker
    ctx.fillStyle = '#fff';
    ctx.fillRect(slotX + 18, midY + 12, 120, 42);
    ctx.fillStyle = '#18385f';
    ctx.font = '28px "Patrick Hand"';
    ctx.fillText('MEMORIES', slotX + 18 + 60, midY + 12 + 22);
  }

  // bottom: star-shaped frame
  const botY = midY + slotH + gap;
  if(captures[2]){
    const img2 = await loadImg(captures[2]);
    ctx.save();
    // create star clipping path centered in the bottom rect
    const cx = slotX + slotW/2;
    const cy = botY + slotH/2;
    const outerR = Math.min(slotW, slotH) * 0.45;
    drawStarPath(ctx, cx, cy, 8, outerR, outerR*0.45);
    ctx.clip();
    // draw image covering area
    const scale2 = Math.max(slotW / img2.width, slotH / img2.height);
    const iw2 = img2.width * scale2, ih2 = img2.height * scale2;
    ctx.drawImage(img2, slotX - (iw2 - slotW)/2, botY - (ih2 - slotH)/2, iw2, ih2);
    ctx.restore();

    // star stroke
    ctx.lineWidth = 10; ctx.strokeStyle = '#b7ead6';
    drawStarPath(ctx, cx, cy, 8, outerR, outerR*0.45);
    ctx.stroke();
  }

  // small scattered decorative stars/dots
  for(let i=0;i<40;i++){
    const rx = 80 + Math.random()*(W-160);
    const ry = 80 + Math.random()*(H-160);
    ctx.fillStyle = ['#fff1a8','#ffd6e8','#cfeff0'][Math.floor(Math.random()*3)];
    ctx.beginPath(); ctx.arc(rx,ry,1 + Math.random()*3,0,Math.PI*2); ctx.fill();
  }

  // footer credit
  ctx.fillStyle = '#18385f';
  ctx.font = '28px "Patrick Hand"';
  ctx.textAlign = 'center';
  ctx.fillText('@tomoji studio', W/2, H - 40);

  return canvas;
}

/* helpers for canvas shapes */
function roundRect(ctx, x, y, w, h, r){
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}

/* star path - draws but DOES NOT stroke/fill by itself unless called */
function drawStarPath(ctx, cx, cy, spikes, outerR, innerR){
  let rot = -Math.PI/2;
  let step = Math.PI / spikes;
  ctx.beginPath();
  for(let i=0;i<spikes;i++){
    let x = cx + Math.cos(rot) * outerR;
    let y = cy + Math.sin(rot) * outerR;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    rot += step;
    x = cx + Math.cos(rot) * innerR;
    y = cy + Math.sin(rot) * innerR;
    ctx.lineTo(x,y);
    rot += step;
  }
  ctx.closePath();
}

/* heart clip implementation: using bezier heart */
function clipHeart(ctx, x, y, w, h){
  const cx = x + w/2;
  const cy = y + h/2.4;
  const top = y + h*0.18;
  ctx.beginPath();
  ctx.moveTo(cx, y + h*0.9);
  ctx.bezierCurveTo(cx + w*0.6, y + h*0.55, cx + w*0.15, top, cx, top + h*0.02);
  ctx.bezierCurveTo(cx - w*0.15, top, cx - w*0.6, y + h*0.55, cx, y + h*0.9);
  ctx.closePath();
}

/* load image helper */
function loadImg(src){
  return new Promise((res, rej)=>{
    const i = new Image();
    i.onload = ()=> res(i);
    i.onerror = rej;
    i.src = src;
  });
}

/* download final canvas as PNG (and create blob URL for QR) */
async function exportFinal(){
  try{
    const canvas = await buildFinalCanvas();
    return new Promise((resolve, reject)=>{
      canvas.toBlob((blob)=>{
        if(!blob) return reject('no blob');
        if(finalBlobUrl) URL.revokeObjectURL(finalBlobUrl);
        finalBlobUrl = URL.createObjectURL(blob);
        resolve({ blob, url: finalBlobUrl, dataUrl: canvas.toDataURL('image/png') });
      }, 'image/png', 0.95);
    });
  }catch(e){
    console.error(e);
    throw e;
  }
}

/* UI: download / QR / print */
downloadBtn.addEventListener('click', async ()=>{
  try{
    const out = await exportFinal();
    const a = document.createElement('a');
    a.href = out.url;
    a.download = 'tomoji_4x6.png';
    a.click();
    // enable other controls
    downloadFinalBtn.disabled = false;
    openLinkBtn.disabled = false;
  }catch(e){ alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå'); }
});

downloadFinalBtn.addEventListener('click', ()=>{
  if(!finalBlobUrl) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå'); const a=document.createElement('a'); a.href=finalBlobUrl; a.download='tomoji_4x6.png'; a.click();
});
openLinkBtn.addEventListener('click', ()=> { if(finalBlobUrl) window.open(finalBlobUrl, '_blank'); });

qrBtn.addEventListener('click', async ()=>{
  try{
    if(!captures[0]) return alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ');
    const out = await exportFinal(); // create blob/url
    qrcodeContainer.innerHTML = '';
    new QRCode(qrcodeContainer, { text: out.url, width: 160, height: 160 });
    // enable download final panel
    downloadFinalBtn.disabled = false;
    openLinkBtn.disabled = false;
    // also enable print and download
    printBtn.disabled = false;
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÑ‡∏î‡πâ'); }
});

printBtn.addEventListener('click', async ()=>{
  try{
    const out = await exportFinal();
    const w = window.open('');
    w.document.write('<img src="'+out.url+'" style="width:360px;display:block;margin:0 auto">');
    w.document.close();
    w.focus();
    w.print();
  }catch(e){ alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ'); }
});

/* upload handler to fill captures */
uploadBtn.addEventListener('click', async ()=>{
  const input = document.createElement('input');
  input.type='file'; input.accept='image/*'; input.multiple=true;
  input.onchange = async (e)=>{
    const files = [...e.target.files].slice(0,3);
    if(files.length < 3){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 3 ‡∏£‡∏π‡∏õ'); return; }
    for(let i=0;i<3;i++){ captures[i] = await fileToDataURL(files[i]); }
    renderSlots();
    retakeBtn.disabled=false; downloadBtn.disabled=false; qrBtn.disabled=false; printBtn.disabled=false;
  };
  input.click();
});

function fileToDataURL(file){
  return new Promise((res,rej)=>{
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

/* utility: render small slot previews inside the result panel (not final canvas) */
function renderSlots(){
  for(let i=0;i<3;i++){
    if(captures[i]){
      slotEls[i].innerHTML = `<img src="${captures[i]}">`;
    }else{
      // placeholder icons/text
      slotEls[i].innerHTML = '';
    }
  }
}

/* keyboard: Enter to shoot */
document.addEventListener('keydown', (e)=>{ if(e.key==='Enter') shutter.click(); });

</script>
</body>
</html>
